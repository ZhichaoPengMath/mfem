## Running the tests

We assume the following directory structure:
```text
mfem/
mfem/tests/smoketests/
mfem-tests/smoketests/runs/
```

### The `runtest` script

The tests in MFEM's smoketest directory can be run directly, e.g.
```sh
cd mfem/tests/smoketests/
./documentation ../..
```
but to detect issues, it is better to run them through the `runtest` script:
```sh
./runtest ../.. documentation
```

The above run will create separate files, `documentation.out` and
`documentation.err` with the standard output and error generated by the script.
A test is considered to pass if its corresponding `*.err` file is empty.

Several tests can be run together:
```sh
./runtest ../.. unit-test code-style
```

Each tests provides a short help message, e.g.
```text
   ./documentation [-h|-help] {mfem_dir}

   where: {mfem_dir}  is the MFEM source directory [default value: ../..]
          -h|-help    prints this usage information and exits

   This script runs several documentation-related tests in mfem_dir.

   Example usage: ./documentation ../..
```
including `runtest`:
```text
   ./runtest [-h|-help] {mfem_dir} {test1} {test2} ...

   where: {mfem_dir}  is the MFEM source directory [default value: ../..]
          {test1}...  are the sequence of tests to run
          -h|-help    prints this usage information and exits

   This script runs a sequence of tests using the code in mfem_dir (note that
   specifying the directory is optional). For each test, the standard output and
   standard error are saved in files test.out and test.err respectively in the
   current directory [1]. The output file interleaves stdout and stderr, while
   the error file is filtered by removing test-specific patterns specified in an
   optional test.filters file in the test directory [2]. After filtering, empty
   error files are erased, signifying that the corresponding test has passed.

   [1] run directory  = /home/kolev/autotest-mfem/tests
   [2] test directory = /home/kolev/autotest-mfem/tests

   Example usage: ./runtest ../..
```

### Baseline

Run the `baseline` test in a sub-directory `runs/`:
```sh
cd mfem-tests/runs
../runtest ../.. baseline
```

If there is no `baseline-hostname.saved` file in `mfem-tests/` we can create it
now:
```sh
cp -p baseline-hostname.out ../baseline-hostname.saved
```

If the file `baseline-hostname.saved` exists, then it is compared to the output
of the above run, `baseline-hostname.out`, and any differences are saved in the
file `baseline-hostname.diff`.

The file `baseline.out` contains compilation output, status messages, etc from
the `baseline` script. For example, if the diff with the `.saved` file fails,
the message at the end of `baseline.out` is:

```text
...

Test FAILED: there are differences with the saved baseline.
For details, see the file: baseline-hostname.diff
```

Any messages that the `baseline` script writes to the standard error are written
to `baseline.out` and at the same time redirected to `baseline.err`. This does
NOT include the standard error output from the examples/miniapps, which instead
is merged with the standard output from the examples/miniapps and written to the
file `baseline-hostname.out`.


### Sample runs

All **serial** sample runs are extracted from the source files **automatically**
using the following two steps (using `app` as an example):

 * from the source file `app.cpp` extract lines beginning with a comment `//`
   that contain the string `app` preceded by **two spaces**;
 * delete all characters in the line before the string `app` to get the
   sample run.

Similarly, all **parallel** sample runs are extracted using:

 * from the source file `app.cpp` extract lines beginning with a comment `//`
   that match `mpirun * app` preceded by **two spaces**;
 * delete all characters in the line before the string `mpirun` to get the
   sample run.

Show all configured serial sample runs:
```sh
cd mfem-tests
./sample-runs ../.. -s
```

Show all configured parallel sample runs:
```sh
./sample-runs ../.. -p -s
```

Show the **serial** sample runs in a specified directory, in files matching a
given pattern:
```sh
./sample-runs ../.. -g examples/sundials "ex{9,10}*.cpp" -s
```
Similarly, to show the **parallel** sample runs in a specified directory, in
files matching a given pattern:
```sh
./sample-runs ../.. -p -g examples/sundials "ex{9,10}*.cpp" -s
```

Build and run all serial sample runs:
```sh
./sample-runs ../.. -j 4
```
The option `-j 4` specifies the number of processor to use when building.

Build and run all parallel sample runs:
```sh
./sample-runs ../.. -p -j 4
```

To execute the sample runs with `valgrind` add the `-v` option.

Build and run all parallel sample runs, and all serial sample runs built with
the parallel library:
```sh
./sample-runs ../.. -p -j 4
./sample-runs ../.. -b
```

Create a **log file** merging `stdout` and `stderr`, using colors `-c`, and
timing each run `-t`:
```sh
./sample-runs -c -t -j 4 ../.. |& tee sample-runs-serial.log       # csh
./sample-runs -c -t -j 4 ../.. 2>&1 | tee sample-runs-serial.log   # bash
```

View the log file, with colors:
```sh
less -R sample-runs-serial.log
```

Extract all **run times** from the log file, with colors:
```sh
grep --color=always -B 1 "Run time:" sample-runs-serial.log | less -R
```
### Build-test

The build-test-basic test will compile serial and parallel MFEM versions and any
 required third party libraries (hypre, metis).  It uses the makefile in
the TPLs repo.

 * Choosing a compiler.  A compiler can be selected by setting the COMPILER
environment variable to a custom compiler name, and then creating a file with
the name Makefile.YOURCOMPILERNAME in the TPL repo.  A xl, gnu, and intel
compiler Makefile is already included in the TPL repo.  If this environment
variable is not set, a default compiler will be selected ( gnu on non-LLNL
 machines ).
