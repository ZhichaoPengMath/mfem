2019/07/09
1 check the colouring for JFNK
2 consider better preconditioner for [v\cdot n ] block
3 write code for Nonlinear

  3a:
	J^T G^-1 ( B x  - f(x) ) = 0
	x = [ q u qhat uhat ]^T

    G=[ V^-1 0
	    0    S^-1]

	B=[ M   D1  0  TU
	    D2  0   TQ 0  ]
    
	f(x) = [ 0  F(u) ]^T

	J= D(Bx-f(x) )/Dx

	Df/Dx = [ 0  0     0  0
	          0 F'(u)  0  0]
    J = B - Df/Dx
	  = [ M    D1     0   TU 
	      D2  -F'(u)  TQ  0  ]

	F'(u) = DF

	J^T G^-1 (Bx - f(x) ) = 0

	J^T G^-1 B
  = [ M^T    D2^T
      D1^T  -DF^T    * [ V^-1M  V^-1D1 0      V^-1TU
	  0      TQ^T        S^-1D2 0      S^-1TQ 0      ]
	  TU^T   0]        
  = [   M^T v^-1 M + D2^T S^-1D2    M^T V^-1 D1    D2^T S^-1 TQ     M^T V ^-1 TU
        D1^TV^-1 M - DF^TS^-1 D2    D1^TV^-1D1     -DF^T S^-1TQ     D1^TV^-1 TU
		TQ^TS^-1 D2                 0              TQ^T S^-1 TQ     0
		TU^T V^-1 M                 TU^TV^-1D1     0                TU^TV^-1 TU    ]

	
	J^T G^-1 B x
  = [   M^T v^-1 M + D2^T S^-1D2    M^T V^-1 D1    D2^T S^-1 TQ     M^T V ^-1 TU       [ q 
        D1^TV^-1 M - DF^TS^-1 D2    D1^TV^-1D1     -DF^T S^-1TQ     D1^TV^-1 TU      *   u
		TQ^TS^-1 D2                 0              TQ^T S^-1 TQ     0                    qhat
		TU^T V^-1 M                 TU^TV^-1D1     0                TU^TV^-1 TU    ]     uhat ]

  = [   (M^T V^-1 M + D2^T S^-1 D2) q + M^T V^-1D1 u  + D2^T S^-1TQ qhat + M^T V^-1TU uhat
        (D1^TV^-1 M - DFu^T S^-1 D2)q + D1^TV^-1D1 u  - DFu^TS^-1TQ qhat + D1^TV^-1TU uhat  
		 TQ^TS^-1D2 q                                 + TQ^TS^-1TQ  qhat
	     TU^TV^-1M  q                 + TU^TV^-1D1u                      +TU^TV^01TU  uhat


    J^T G^-1 f(x)
  = [ M^T   D2^T
      D1^T -DF^T     * [V^-1   0      *   [ 0
	  0     TQ^T        0      S^-1]        Fu]
	  TU^T  0   ]
  = [ M^T V^-1      D2^T S^-1
      D1^T V^-1    -DF^T S^-1     * [0
	  0             TQ^T S^-1        Fu]
	  TU^T V^01     0         ]
  = [ D2^T S^-1 Fu  
     -DFu^T S^-1 Fu
	  TQ^T S^-1 Fu
	  0             ]


     J^T G^-1(Bx- f(x) ) 
  = [   (M^T V^-1 M + D2^T S^-1 D2) q + (M^T V^-1D1 u - D2^T S^-1Fu)  + D2^T S^-1TQ qhat + M^T V^-1TU uhat
        (D1^TV^-1 M - DFu^T S^-1 D2)q + (D1^TV^-1D1 u + DFu^TS^-1Fu)  - DFu^TS^-1TQ qhat + D1^TV^-1TU uhat  
		 TQ^TS^-1D2 q                 -  TQ^T S^-1 Fu                 + TQ^TS^-1TQ  qhat
	     TU^TV^-1M  q                 + TU^TV^-1D1u                                      +TU^TV^01TU  uhat



 Jacobian of J^T G^-1( Bx - f(x) )
          J = d(Bx-f(x) )
          J1 =   J^T G^-1 J
		  J2 =   dJ^T/dx G^-1 ( Bx-f(x) )

	J1 
  = J^T G^-1 J 
  = [ M^T    D2^T
      D1^T  -DF^T    * [ V^-1M   V^-1D1  0      V^-1TU
	  0      TQ^T        S^-1D2 -S^-1DF  S^-1TQ 0      ]
	  TU^T   0]        
  = [   M^T v^-1 M + D2^T S^-1D2    M^T V^-1 D1 -D2^TS^-1DF    D2^T S^-1 TQ     M^T V ^-1 TU
        D1^TV^-1 M - DF^TS^-1 D2    D1^T V^-1 D1+DF^TS^-1DF   -DF^T S^-1TQ      D1^TV^-1 TU
		TQ^TS^-1 D2                -TQ^T S^-1DF                TQ^T S^-1 TQ     0
		TU^T V^-1 M                 TU^TV^-1D1                 0                TU^TV^-1 TU    ]
 
    J2  
  = [   0                  0                      0                  0 
        0      DDFu^T S^-1(-D2 q+Fu-TQqhat)       0                  0
		0                  0                      0                  0 
		0                  0                      0                  0   ]
    
  Calculating DDFu^T S^-1(-D2 q +Fu - TQqhat)

  Dfu^T S^-1 v(i) = [ Dfu^T(i,:) S^-1 v ]

  d( Dfu^T S^-1 v(i) )/du(j) = [ dDfu^T(i,:)/du(j) ] S^-1 v

  DDFu^T S^-1(-D2 q + Fu - TQqhat)(i,j) = [ dDfu^T(i,:)/du(j) ] S^-1 (-D2 q + Fu -TQqhat)
  DDFu^T S^-1(-D2 q + Fu - TQqhat)(:,j) = [ dDfu^T(:,:)/du(j) ] S^-1 (-D2 q + Fu -TQqhat)

  Personally speaking, I think this structure is easy for Matlab, but bad for parallel 



 3b: plans
	(i)  linear case rewrtie the JFNK solver in J^T G^-1 (Bx - f(x) ) form
	(ii) Define DF
	(iii) get ``Jacobian" or preconditioner


Questions: How to use Hypre AMS and ADS in petsc?
