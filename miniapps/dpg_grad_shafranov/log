2019/07/09
1 check the colouring for JFNK
2 consider better preconditioner for [v\cdot n ] block
3 write code for Nonlinear

  3a:
	J^T G^-1 ( B x  - f(x) ) = 0
	x = [ q u qhat uhat ]^T

    G=[ V^-1 0
	    0    S^-1]

	B=[ M   DU  0  TU
	    DQ  0   TQ 0  ]
    
	f(x) = [ 0  F(u) ]^T

	J= D(Bx-f(x) )/Dx

	Df/Dx = [ 0  0     0  0
	          0 F'(u)  0  0]
    J = B - Df/Dx
	  = [ M    DU     0   TU 
	      DQ  -F'(u)  TQ  0  ]

	F'(u) = DF

	J^T G^-1 (Bx - f(x) ) = 0

	J^T G^-1 B
  = [ M^T    DQ^T
      DU^T  -DF^T    * [ V^-1M  V^-1DU 0      V^-1TU
	  0      TQ^T        S^-1DQ 0      S^-1TQ 0      ]
	  TU^T   0]        
  = [   M^T v^-1 M + DQ^T S^-1DQ    M^T V^-1 DU    DQ^T S^-1 TQ     M^T V ^-1 TU
        DU^TV^-1 M - DF^TS^-1 DQ    DU^TV^-1DU     -DF^T S^-1TQ     DU^TV^-1 TU
		TQ^TS^-1 DQ                 0              TQ^T S^-1 TQ     0
		TU^T V^-1 M                 TU^TV^-1DU     0                TU^TV^-1 TU    ]

	
	J^T G^-1 B x
  = [   M^T v^-1 M + DQ^T S^-1DQ    M^T V^-1 DU    DQ^T S^-1 TQ     M^T V ^-1 TU       [ q 
        DU^TV^-1 M - DF^TS^-1 DQ    DU^TV^-1DU     -DF^T S^-1TQ     DU^TV^-1 TU      *   u
		TQ^TS^-1 DQ                 0              TQ^T S^-1 TQ     0                    qhat
		TU^T V^-1 M                 TU^TV^-1DU     0                TU^TV^-1 TU    ]     uhat ]

  = [   (M^T V^-1 M + DQ^T S^-1 DQ) q + M^T V^-1DU u  + DQ^T S^-1TQ qhat + M^T V^-1TU uhat
        (DU^TV^-1 M - DFu^T S^-1 DQ)q + DU^TV^-1DU u  - DFu^TS^-1TQ qhat + DU^TV^-1TU uhat  
		 TQ^TS^-1DQ q                                 + TQ^TS^-1TQ  qhat
	     TU^TV^-1M  q                 + TU^TV^-1DUu                      +TU^TV^01TU  uhat


    J^T G^-1 f(x)
  = [ M^T   DQ^T
      DU^T -DF^T     * [V^-1   0      *   [ 0
	  0     TQ^T        0      S^-1]        Fu]
	  TU^T  0   ]
  = [ M^T V^-1      DQ^T S^-1
      DU^T V^-1    -DF^T S^-1     * [0
	  0             TQ^T S^-1        Fu]
	  TU^T V^01     0         ]
  = [ DQ^T S^-1 Fu  
     -DFu^T S^-1 Fu
	  TQ^T S^-1 Fu
	  0             ]


     J^T G^-1(Bx- f(x) ) 
  = [   (M^T V^-1 M + DQ^T S^-1 DQ) q + (M^T V^-1DU u - DQ^T S^-1Fu)  + DQ^T S^-1TQ qhat + M^T V^-1TU uhat
        (DU^TV^-1 M - DFu^T S^-1 DQ)q + (DU^TV^-1DU u + DFu^TS^-1Fu)  - DFu^TS^-1TQ qhat + DU^TV^-1TU uhat  
		 TQ^TS^-1DQ q                 -  TQ^T S^-1 Fu                 + TQ^TS^-1TQ  qhat
	     TU^TV^-1M  q                 + TU^TV^-1DUu                                      +TU^TV^01TU  uhat



 Jacobian of J^T G^-1( Bx - f(x) )
          J = d(Bx-f(x) )
          J1 =   J^T G^-1 J
		  J2 =   dJ^T/dx G^-1 ( Bx-f(x) )

	J1 
  = J^T G^-1 J 
  = [ M^T    DQ^T
      DU^T  -DF^T    * [ V^-1M   V^-1DU  0      V^-1TU
	  0      TQ^T        S^-1DQ -S^-1DF  S^-1TQ 0      ]
	  TU^T   0]        
  = [   M^T v^-1 M + DQ^T S^-1DQ    M^T V^-1 DU -DQ^TS^-1DF    DQ^T S^-1 TQ     M^T V ^-1 TU
        DU^TV^-1 M - DF^TS^-1 DQ    DU^T V^-1 DU+DF^TS^-1DF   -DF^T S^-1TQ      DU^TV^-1 TU
		TQ^TS^-1 DQ                -TQ^T S^-1DF                TQ^T S^-1 TQ     0
		TU^T V^-1 M                 TU^TV^-1DU                 0                TU^TV^-1 TU    ]
 
    J2  
  = [   0                  0                      0                  0 
        0      DDFu^T S^-1(-DQ q+Fu-TQqhat)       0                  0
		0                  0                      0                  0 
		0                  0                      0                  0   ]
    
  Calculating DDFu^T S^-1(-DQ q +Fu - TQqhat)

  Dfu^T S^-1 v(i) = [ Dfu^T(i,:) S^-1 v ]

  d( Dfu^T S^-1 v(i) )/du(j) = [ dDfu^T(i,:)/du(j) ] S^-1 v

  DDFu^T S^-1(-DQ q + Fu - TQqhat)(i,j) = [ dDfu^T(i,:)/du(j) ] S^-1 (-DQ q + Fu -TQqhat)
  DDFu^T S^-1(-DQ q + Fu - TQqhat)(:,j) = [ dDfu^T(:,:)/du(j) ] S^-1 (-DQ q + Fu -TQqhat)

  Personally speaking, I think this structure is easy for Matlab, but bad for parallel 



 3b: plans
	(i)  linear case rewrtie the JFNK solver in J^T G^-1 (Bx - f(x) ) form
	(ii) Define DF
	(iii) get ``Jacobian" or preconditioner


Questions: How to use Hypre AMS and ADS in petsc?
